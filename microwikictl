#!/bin/bash

set -e

ALL="prom etcd conf bal redis pages1 pages2 preso dash"
HIDE_FROM_SCOPE="-l works.weave.role=system"
CURL="docker run --rm --entrypoint=/usr/bin/curl weaveworks/weaveexec"

VERSION=${VERSION:-latest}

reg_service() {
    local service=$1
    local ipaddr=$2
    local port=$3
    local image=$4
    weave dns-add $ipaddr weave -h $service.weave.local
    echo coatlctl service add $service $ipaddr $port --docker-image=$image
    docker run --rm \
        -e ETCD_ADDRESS=http://etcd:4001 \
        bboreham/coatlctl service add $service $ipaddr $port --docker-image=$image
}

do_up() {
    for c in "$@"; do
        echo Starting $c ...
        case $c in
            pages*)
                # pages service
                docker run -d --name $c \
                    -e INSTANCE=$c \
                    -e REDIS_SVC=redis-svc.weave.local \
                    --hostname pages.weave.local micro-wiki/pages:$VERSION
                ;;
            preso)
                # preso front end
                docker run -d --name preso --restart=always \
                    -e PAGES_SVC=pages-svc.weave.local \
                    -p 8080:80 --hostname preso.weave.local micro-wiki/preso
                ;;
            prom)
                # prometheus
                docker run -d --name prom \
                    -v `pwd`/prom:/etc/prometheus -p 9090:9090 \
                    $HIDE_FROM_SCOPE \
                    prom/prometheus:master
                ;;
            redis)
                docker run -d --name redis \
                    --hostname redis-svc.weave.local \
                    litaio/redis
                ;;
            etcd)
                docker run -d --name etcd \
                    -h etcd.weave.local \
                    $HIDE_FROM_SCOPE \
                    quay.io/coreos/etcd \
                    -advertise-client-urls http://etcd:4001 \
                    -listen-client-urls http://0.0.0.0:4001
                ;;
            conf)
                reg_service pages-svc 10.128.0.5 80 micro-wiki/pages || true
                docker run -d --name conf \
                    -h conf.weave.local \
                    $HIDE_FROM_SCOPE \
                    -v /var/run/weave.sock:/var/run/docker.sock \
                    -e ETCD_ADDRESS=http://etcd:4001 \
                    bboreham/dlisten
                ;;
            bal)
                local etcd_ip=$(docker inspect --format='{{.NetworkSettings.IPAddress}}' etcd)
                docker run --name bal \
                    -d --net=host --privileged \
                    -e ETCD_ADDRESS=http://$etcd_ip:4001 \
                    ambergris/server
                ;;
            dash)
                docker run -d --name dash \
                    -p 3000:7070 \
                    weevil/server
                ;;
            *)
                echo "Sorry which service?" >&2
        esac
    done
}

do_down() {
    for c in "$@"; do
        docker rm -f $c || true
    done
}

do_load() {
    docker rm -f load || true
    docker run --name load micro-wiki/load
}

COMMAND=$1
shift 1
ARGS="$@"
if [ -z "$ARGS" ]; then
    ARGS=$ALL
fi

case $COMMAND in
    up)
        do_up $ARGS
        ;;
    down)
        do_down $ARGS
        ;;
    restart)
        do_down $ARGS
        do_up $ARGS
        ;;
    load)
        do_load
        ;;
    start-infra)
        weave launch-router
        weave expose
        weave launch-proxy --rewrite-inspect \
            -H tcp://0.0.0.0:12375 -H unix:///var/run/weave.sock
        echo
        echo 'Now do eval $(weave env)'
        ;;
    *)
        echo Unrecognised command "$1"
        ;;
esac
