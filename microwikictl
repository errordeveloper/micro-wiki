#!/bin/bash

do_up() {
    case $1 in
        "")
            do_up prom
            do_up redis
            do_up pages1
            do_up pages2
            do_up preso
            ;;
        pages1)
            # pages service
            docker run -d --name pages1 \
                -e INSTANCE=pages1 \
                -e REDIS_SVC=redis.weave.local \
                --hostname pages.weave.local micro-wiki/pages
            ;;
        pages2)
            # pages service, instance two please
            docker run -d --name pages2 \
                -e INSTANCE=pages2 \
                -e REDIS_SVC=redis.weave.local \
                --hostname pages.weave.local micro-wiki/pages
            ;;
        preso)
            # preso front end
            docker run -d --name preso \
                -e PAGES_SVC=pages.weave.local \
                -p 8080:80 --hostname preso.weave.local micro-wiki/preso
            ;;
        prom)
            # prometheus
            docker run -d -p 9090:9090 --name prom -v `pwd`/prom:/etc/prometheus prom/prometheus:master
            ;;
        redis)
            docker run -d --name redis \
                --hostname redis.weave.local \
                litaio/redis
            ;;
        *)
            echo "Sorry which service?" >&2
    esac
}

do_down() {
#    docker rm -f etcd
    if [ -z "$1" ]; then
        docker rm -f preso pages1 pages2 prom redis
    else
        docker rm -f $1
    fi
}

do_load() {
    docker rm -f load
    docker run --name load micro-wiki/load
}

case $1 in
    up)
        do_up $2
        ;;
    down)
        do_down $2
        ;;
    restart)
        do_down $2
        do_up $2
        ;;
    load)
        do_load
        ;;
esac
